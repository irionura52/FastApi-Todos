- name: Set up SSH and Deploy
  env:
    SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    SERVER_IP: ${{ secrets.SERVER_IP }}
    SERVER_USER: ${{ secrets.SERVER_USER }}
    APP_PATH: "/home/${{ secrets.SERVER_USER }}/FastApi-Todos"

  run: |
    echo "$SSH_PRIVATE_KEY" > private_key
    chmod 600 private_key
    ssh -o StrictHostKeyChecking=no -i private_key $SERVER_USER@$SERVER_IP << EOF
      set -e
      
      # ðŸ‘‰ í˜„ìž¬ ê²½ë¡œë¡œ ì´ë™
      cd \$APP_PATH

      # ðŸªµ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
      echo "[DEBUG] í˜„ìž¬ ê²½ë¡œëŠ”:"
      pwd

      echo "[DEBUG] .git í´ë” ìžˆëŠ”ì§€ í™•ì¸:"
      ls -a

      echo "[DEBUG] git status ê²°ê³¼:"
      git status

      # ðŸ‘‰ Git ìµœì‹  ì½”ë“œë¡œ ë¦¬ì…‹
      git fetch origin
      git reset --hard origin/main

      # ðŸ‘‰ ì•± í´ë”ë¡œ ì´ë™
      cd fastapi-app

      # ðŸ‘‰ ê°€ìƒí™˜ê²½ í™œì„±í™”
      source /home/\$USER/myenv/bin/activate
      pip install -r requirements.txt

      # ðŸ‘‰ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
      pkill -f "uvicorn main:app" || true

      # ðŸ‘‰ ì•± ì‹¤í–‰
      nohup setsid uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4 > ../uvicorn.log 2>&1 &
    EOF
